<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Precious Metals Trading Dashboard - XAU/USD & XAG/USD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://s3.tradingview.com/tv.js"></script>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-gold: #fbbf24;
            --accent-silver: #94a3b8;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
        }
        body { background-color: var(--bg-primary); color: var(--text-primary); }
        .card { background-color: var(--bg-secondary); border-radius: 0.75rem; }
        .gold-gradient { background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%); }
        .silver-gradient { background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%); }
        .signal-buy { border-left: 4px solid var(--accent-green); }
        .signal-sell { border-left: 4px solid var(--accent-red); }
        .risk-low { color: var(--accent-green); background: rgba(34, 197, 94, 0.1); }
        .risk-moderate { color: var(--accent-gold); background: rgba(251, 191, 36, 0.1); }
        .risk-high { color: #f97316; background: rgba(249, 115, 22, 0.1); }
        .risk-highest { color: var(--accent-red); background: rgba(239, 68, 68, 0.1); }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .tradingview-widget-container { height: 350px; }
        .indicator-bar { height: 6px; border-radius: 3px; background: #334155; }
        .indicator-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
        .scroll-thin::-webkit-scrollbar { width: 4px; }
        .scroll-thin::-webkit-scrollbar-track { background: #1e293b; }
        .scroll-thin::-webkit-scrollbar-thumb { background: #475569; border-radius: 2px; }

        /* Glint-style news ticker */
        .news-ticker-wrap { overflow: hidden; white-space: nowrap; position: relative; }
        .news-ticker-inner { display: inline-block; animation: tickerScroll 60s linear infinite; }
        .news-ticker-inner:hover { animation-play-state: paused; }
        @keyframes tickerScroll {
            0%   { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .ticker-item { display: inline-flex; align-items: center; gap: 6px; margin-right: 48px; cursor: default; }
        .badge-critical { background: rgba(239,68,68,0.2); color: #f87171; border: 1px solid rgba(239,68,68,0.4); }
        .badge-high     { background: rgba(249,115,22,0.2); color: #fb923c; border: 1px solid rgba(249,115,22,0.4); }
        .badge-low      { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.3); }
        .badge-neutral  { background: rgba(148,163,184,0.15); color: #94a3b8; border: 1px solid rgba(148,163,184,0.3); }

        /* Signal count badge */
        .signal-live { display: flex; align-items: center; gap: 6px; }
        .signal-dot { width: 8px; height: 8px; border-radius: 50%; background: #22c55e; animation: pulse 1.5s infinite; }

        /* Polymarket card */
        .pm-card { border-left: 3px solid; border-radius: 0.5rem; padding: 8px 12px; margin-bottom: 6px; }
        .pm-bullish { border-color: #22c55e; background: rgba(34,197,94,0.08); }
        .pm-bearish { border-color: #ef4444; background: rgba(239,68,68,0.08); }
        .pm-neutral { border-color: #475569; background: rgba(71,85,105,0.15); }
        .pm-bar { height: 4px; border-radius: 2px; background: #334155; margin-top: 6px; position: relative; overflow: hidden; }
        .pm-bar-yes { height: 100%; background: linear-gradient(90deg, #22c55e, #16a34a); border-radius: 2px; }
        .volume-chip { font-size: 10px; padding: 1px 6px; background: rgba(59,130,246,0.15); color: #93c5fd; border-radius: 99px; }

        /* Glint-style events feed */
        .event-feed-item { padding: 8px 10px; border-radius: 6px; margin-bottom: 5px; background: rgba(30,41,59,0.6); border: 1px solid rgba(71,85,105,0.3); transition: background 0.2s; }
        .event-feed-item:hover { background: rgba(30,41,59,1); }
        .bias-pill { font-size: 10px; padding: 2px 8px; border-radius: 99px; font-weight: 700; letter-spacing: 0.05em; }
        .bias-bullish { background: rgba(34,197,94,0.2); color: #4ade80; }
        .bias-bearish { background: rgba(239,68,68,0.2); color: #f87171; }
        .bias-neutral  { background: rgba(148,163,184,0.15); color: #94a3b8; }
    </style>
</head>
<body class="min-h-screen p-4">
    <!-- Live News Ticker (Glint-style) -->
    <div class="mb-3 bg-slate-900 border border-slate-700/60 rounded-lg py-2 px-3 flex items-center gap-3 overflow-hidden">
        <div class="flex items-center gap-2 flex-shrink-0">
            <span class="signal-dot"></span>
            <span class="text-xs font-bold text-green-400 uppercase tracking-widest">LIVE</span>
        </div>
        <div class="news-ticker-wrap flex-1">
            <div id="newsTicker" class="news-ticker-inner text-sm text-gray-300">
                <span class="ticker-item text-gray-500">Loading live events...</span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <h1 class="text-2xl font-bold">Precious Metals Trading</h1>
                <span class="px-3 py-1 text-sm rounded-full gold-gradient text-black font-semibold">XAU/USD</span>
                <span class="px-3 py-1 text-sm rounded-full silver-gradient text-black font-semibold">XAG/USD</span>
            </div>
            <div class="flex items-center gap-4">
                <!-- Active Signals Counter -->
                <div class="signal-live px-3 py-1.5 bg-slate-800 rounded-lg border border-slate-600">
                    <span class="signal-dot"></span>
                    <span id="activeSignalCount" class="text-lg font-bold text-white">0</span>
                    <span class="text-xs text-gray-400">ACTIVE SIGNALS</span>
                </div>
                <div id="sessionInfo" class="text-sm">
                    <span class="text-gray-400">Session:</span>
                    <span id="currentSession" class="font-semibold">Loading...</span>
                    <span id="sessionRisk" class="ml-2 px-2 py-0.5 rounded text-xs">-</span>
                </div>
                <button id="refreshBtn" onclick="handleRefresh()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm font-medium transition flex items-center gap-2">
                    <span id="refreshIcon">↻</span>
                    <span id="refreshText">Refresh</span>
                </button>
                <span id="lastUpdate" class="text-sm text-gray-400">--:--:--</span>
            </div>
        </div>
    </header>

    <!-- Main Grid -->
    <div class="grid grid-cols-12 gap-4">
        <!-- Left Column: Charts & Analysis -->
        <div class="col-span-8 space-y-4">
            <!-- Dual Charts -->
            <div class="grid grid-cols-2 gap-4">
                <!-- XAU/USD Chart -->
                <div class="card p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full gold-gradient"></span>
                            XAU/USD (Gold)
                        </h2>
                        <div id="xauPrice" class="text-xl font-bold text-yellow-400">---.--</div>
                    </div>
                    <div id="xauChart" class="tradingview-widget-container"></div>
                </div>
                <!-- XAG/USD Chart -->
                <div class="card p-4">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-lg font-semibold flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full silver-gradient"></span>
                            XAG/USD (Silver)
                        </h2>
                        <div id="xagPrice" class="text-xl font-bold text-gray-300">---.--</div>
                    </div>
                    <div id="xagChart" class="tradingview-widget-container"></div>
                </div>
            </div>

            <!-- Correlation Dashboard -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-3">Market Correlations</h2>
                <div id="correlations" class="grid grid-cols-6 gap-3">
                    <div class="text-center p-3 bg-slate-700/50 rounded-lg">
                        <div class="text-xs text-gray-400">DXY</div>
                        <div id="dxyPrice" class="text-lg font-semibold">---.--</div>
                        <div id="dxyChange" class="text-sm">--%</div>
                        <div class="text-xs text-gray-500 mt-1">Inverse</div>
                    </div>
                    <div class="text-center p-3 bg-slate-700/50 rounded-lg">
                        <div class="text-xs text-gray-400">US10Y</div>
                        <div id="us10yPrice" class="text-lg font-semibold">--.--</div>
                        <div id="us10yChange" class="text-sm">--%</div>
                        <div class="text-xs text-gray-500 mt-1">Inverse</div>
                    </div>
                    <div class="text-center p-3 bg-slate-700/50 rounded-lg">
                        <div class="text-xs text-gray-400">S&P 500</div>
                        <div id="spyPrice" class="text-lg font-semibold">----.--</div>
                        <div id="spyChange" class="text-sm">--%</div>
                        <div class="text-xs text-gray-500 mt-1">Risk-off</div>
                    </div>
                    <div class="text-center p-3 bg-slate-700/50 rounded-lg">
                        <div class="text-xs text-gray-400">VIX</div>
                        <div id="vixPrice" class="text-lg font-semibold">---.--</div>
                        <div id="vixChange" class="text-sm">--%</div>
                        <div class="text-xs text-gray-500 mt-1">Positive</div>
                    </div>
                    <div class="text-center p-3 bg-slate-700/50 rounded-lg">
                        <div class="text-xs text-gray-400">EUR/USD</div>
                        <div id="eurusdPrice" class="text-lg font-semibold">-.----</div>
                        <div id="eurusdChange" class="text-sm">--%</div>
                        <div class="text-xs text-gray-500 mt-1">Positive</div>
                    </div>
                    <div class="text-center p-3 bg-slate-700/50 rounded-lg">
                        <div class="text-xs text-gray-400">Oil</div>
                        <div id="oilPrice" class="text-lg font-semibold">---.--</div>
                        <div id="oilChange" class="text-sm">--%</div>
                        <div class="text-xs text-gray-500 mt-1">Positive</div>
                    </div>
                </div>
            </div>

            <!-- Manipulation Detection with History -->
            <div class="card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold">Manipulation Detection</h2>
                    <div id="manipulationScore" class="flex items-center gap-2">
                        <span class="text-sm text-gray-400">Risk Score:</span>
                        <span id="riskScoreValue" class="text-lg font-bold">--</span>
                    </div>
                </div>

                <!-- Current Alerts -->
                <div id="manipulationAlerts" class="space-y-2 mb-4">
                    <div class="p-3 bg-slate-700/30 rounded-lg text-gray-400 text-sm">
                        No manipulation alerts at this time
                    </div>
                </div>

                <!-- Key Levels - Better Structure -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">Support Levels</h3>
                        <div id="supportLevels" class="space-y-1">
                            <div class="flex justify-between p-2 bg-green-900/20 rounded text-sm">
                                <span class="text-green-400">S1</span>
                                <span class="text-green-300">---.--</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-400 mb-2">Resistance Levels</h3>
                        <div id="resistanceLevels" class="space-y-1">
                            <div class="flex justify-between p-2 bg-red-900/20 rounded text-sm">
                                <span class="text-red-400">R1</span>
                                <span class="text-red-300">---.--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Manipulation History (Last 10 in 24h) -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-400 mb-2">Recent Manipulation Events (24h)</h3>
                    <div id="manipulationHistory" class="max-h-32 overflow-y-auto scroll-thin space-y-1">
                        <div class="text-xs text-gray-500 p-2 bg-slate-700/20 rounded">No recent events</div>
                    </div>
                </div>
            </div>

            <!-- Market Intelligence Summary -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span>Market Intelligence</span>
                    <span class="text-xs bg-blue-600 px-2 py-0.5 rounded">LIVE</span>
                </h2>
                <div id="marketIntelligence" class="space-y-4">
                    <!-- Gold Summary -->
                    <div class="p-3 bg-yellow-900/10 border-l-4 border-yellow-500 rounded-r">
                        <h4 class="font-semibold text-yellow-400 mb-2">Gold (XAU/USD) Summary</h4>
                        <div id="goldSummary" class="text-sm text-gray-300 space-y-2">
                            <p>Loading market intelligence...</p>
                        </div>
                    </div>

                    <!-- Silver Summary -->
                    <div class="p-3 bg-gray-700/30 border-l-4 border-gray-400 rounded-r">
                        <h4 class="font-semibold text-gray-300 mb-2">Silver (XAG/USD) Summary</h4>
                        <div id="silverSummary" class="text-sm text-gray-300 space-y-2">
                            <p>Loading market intelligence...</p>
                        </div>
                    </div>

                    <!-- Central Bank & Government Actions -->
                    <div class="p-3 bg-blue-900/10 border-l-4 border-blue-500 rounded-r">
                        <h4 class="font-semibold text-blue-400 mb-2">Central Bank & Government Activity</h4>
                        <div id="centralBankSummary" class="text-sm text-gray-300 space-y-1">
                            <p>Loading policy updates...</p>
                        </div>
                    </div>

                    <!-- Contract Expiry & Delivery -->
                    <div class="p-3 bg-purple-900/10 border-l-4 border-purple-500 rounded-r">
                        <h4 class="font-semibold text-purple-400 mb-2">Futures & Contract Info</h4>
                        <div id="contractInfo" class="text-sm text-gray-300 space-y-1">
                            <p>Loading contract data...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ===== POLYMARKET INTEL PANEL ===== -->
            <div class="card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <span class="text-violet-400">◈</span>
                        Polymarket Intel
                        <span class="text-xs bg-violet-700 px-2 py-0.5 rounded">PREDICTION MARKETS</span>
                    </h2>
                    <div id="polyBiasChip" class="bias-pill bias-neutral">NEUTRAL</div>
                </div>
                <p class="text-xs text-gray-500 mb-3">Crowd-sourced probability estimates for events affecting XAU/XAG prices</p>

                <!-- Metals-relevant markets -->
                <div id="polymarketsMetals" class="space-y-1 mb-3">
                    <div class="text-xs text-gray-500 p-3 text-center">Loading prediction markets...</div>
                </div>

                <!-- Geopolitical markets -->
                <div class="border-t border-slate-700 pt-3 mt-1">
                    <h4 class="text-xs font-semibold text-gray-400 mb-2 uppercase tracking-wide">Geopolitical Risk Events</h4>
                    <div id="polymarketsGeo" class="space-y-1">
                        <div class="text-xs text-gray-500 p-2 text-center">Loading...</div>
                    </div>
                </div>

                <!-- Polymarket summary -->
                <div class="mt-3 pt-3 border-t border-slate-700 grid grid-cols-3 gap-2 text-center text-xs">
                    <div class="p-2 bg-slate-700/30 rounded">
                        <div class="text-gray-400">Markets</div>
                        <div id="polyMarketCount" class="font-bold text-white">--</div>
                    </div>
                    <div class="p-2 bg-slate-700/30 rounded">
                        <div class="text-gray-400">Bias</div>
                        <div id="polyOverallBias" class="font-bold">--</div>
                    </div>
                    <div class="p-2 bg-slate-700/30 rounded">
                        <div class="text-gray-400">Vol (USD)</div>
                        <div id="polyTotalVol" class="font-bold text-blue-300">--</div>
                    </div>
                </div>
            </div>

            <!-- ===== GLOBAL EVENTS FEED ===== -->
            <div class="card p-4">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <span class="text-orange-400">⚡</span>
                        Trending Markets
                        <span class="text-xs bg-orange-700/60 px-2 py-0.5 rounded animate-pulse">LIVE</span>
                    </h2>
                    <div class="flex gap-1">
                        <button onclick="filterFeed('all')" id="feedAll" class="px-2 py-0.5 text-xs rounded bg-slate-600 text-white">All</button>
                        <button onclick="filterFeed('bullish')" id="feedBull" class="px-2 py-0.5 text-xs rounded bg-slate-700 text-gray-400">Bull</button>
                        <button onclick="filterFeed('bearish')" id="feedBear" class="px-2 py-0.5 text-xs rounded bg-slate-700 text-gray-400">Bear</button>
                    </div>
                </div>
                <div id="globalEventsFeed" class="space-y-1 max-h-72 overflow-y-auto scroll-thin">
                    <div class="text-xs text-gray-500 p-3 text-center">Loading events feed...</div>
                </div>
            </div>
        </div>

        <!-- Right Column: Signals & P&L -->
        <div class="col-span-4 space-y-4">
            <!-- Gold Signal -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full gold-gradient"></span>
                    XAU/USD Signal
                </h2>
                <div id="goldSignal">
                    <div class="p-3 bg-slate-700/30 rounded-lg text-center text-gray-400 text-sm">
                        No active signal
                    </div>
                </div>
                <!-- Gold Indicators -->
                <div class="mt-3 pt-3 border-t border-slate-700">
                    <h4 class="text-xs font-semibold text-gray-400 mb-2">Technical Indicators</h4>
                    <div class="space-y-2">
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">RSI (14)</span>
                                <span id="goldRsiValue" class="font-semibold">50</span>
                            </div>
                            <div class="indicator-bar">
                                <div id="goldRsiBar" class="indicator-fill bg-blue-500" style="width: 50%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-0.5">
                                <span>Oversold</span>
                                <span>Overbought</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="p-2 bg-slate-700/30 rounded">
                                <span class="text-gray-400">MACD</span>
                                <div id="goldMacd" class="font-semibold">0.00</div>
                            </div>
                            <div class="p-2 bg-slate-700/30 rounded">
                                <span class="text-gray-400">Signal</span>
                                <div id="goldMacdSignal" class="font-semibold">0.00</div>
                            </div>
                            <div class="p-2 bg-slate-700/30 rounded">
                                <span class="text-gray-400">EMA 9</span>
                                <div id="goldEma9" class="font-semibold">---.--</div>
                            </div>
                            <div class="p-2 bg-slate-700/30 rounded">
                                <span class="text-gray-400">EMA 21</span>
                                <div id="goldEma21" class="font-semibold">---.--</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-slate-700/30 rounded">
                            <span class="text-xs text-gray-400">Market Bias</span>
                            <span id="goldBias" class="text-xs font-semibold px-2 py-0.5 rounded bg-gray-600">NEUTRAL</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Silver Signal -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-3 flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full silver-gradient"></span>
                    XAG/USD Signal
                </h2>
                <div id="silverSignal">
                    <div class="p-3 bg-slate-700/30 rounded-lg text-center text-gray-400 text-sm">
                        No active signal
                    </div>
                </div>
                <!-- Silver Indicators -->
                <div class="mt-3 pt-3 border-t border-slate-700">
                    <h4 class="text-xs font-semibold text-gray-400 mb-2">Technical Indicators</h4>
                    <div class="space-y-2">
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span class="text-gray-400">RSI (14)</span>
                                <span id="silverRsiValue" class="font-semibold">50</span>
                            </div>
                            <div class="indicator-bar">
                                <div id="silverRsiBar" class="indicator-fill bg-blue-500" style="width: 50%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 mt-0.5">
                                <span>Oversold</span>
                                <span>Overbought</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="p-2 bg-slate-700/30 rounded">
                                <span class="text-gray-400">MACD</span>
                                <div id="silverMacd" class="font-semibold">0.00</div>
                            </div>
                            <div class="p-2 bg-slate-700/30 rounded">
                                <span class="text-gray-400">Signal</span>
                                <div id="silverMacdSignal" class="font-semibold">0.00</div>
                            </div>
                            <div class="p-2 bg-slate-700/30 rounded">
                                <span class="text-gray-400">EMA 9</span>
                                <div id="silverEma9" class="font-semibold">---.--</div>
                            </div>
                            <div class="p-2 bg-slate-700/30 rounded">
                                <span class="text-gray-400">EMA 21</span>
                                <div id="silverEma21" class="font-semibold">---.--</div>
                            </div>
                        </div>
                        <div class="flex justify-between items-center p-2 bg-slate-700/30 rounded">
                            <span class="text-xs text-gray-400">Market Bias</span>
                            <span id="silverBias" class="text-xs font-semibold px-2 py-0.5 rounded bg-gray-600">NEUTRAL</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scalp Trading Section -->
            <div class="card p-4 border-2 border-cyan-500/30">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <span class="text-cyan-400">⚡</span>
                        Scalp Trading
                        <span class="text-xs bg-cyan-600 px-2 py-0.5 rounded animate-pulse">LIVE</span>
                    </h2>
                    <select id="scalpSymbol" class="bg-slate-700 text-sm rounded px-2 py-1 border border-slate-600" onchange="fetchScalpSuggestions()">
                        <option value="XAU/USD">Gold (XAU)</option>
                        <option value="XAG/USD">Silver (XAG)</option>
                    </select>
                </div>

                <!-- Action Banner -->
                <div id="scalpAction" class="p-3 rounded-lg mb-3 text-center bg-slate-700/50">
                    <div class="text-2xl font-bold mb-1">ANALYZING...</div>
                    <div class="text-sm text-gray-400">Loading market data</div>
                </div>

                <!-- Entry Details -->
                <div id="scalpEntry" class="hidden mb-3">
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="p-2 bg-slate-700/50 rounded">
                            <span class="text-gray-400">Entry</span>
                            <div id="scalpEntryPrice" class="font-bold text-lg">--</div>
                        </div>
                        <div class="p-2 bg-slate-700/50 rounded">
                            <span class="text-gray-400">Stop Loss</span>
                            <div id="scalpSL" class="font-bold text-lg text-red-400">--</div>
                        </div>
                        <div class="p-2 bg-green-900/30 rounded">
                            <span class="text-gray-400">TP1 (1:1)</span>
                            <div id="scalpTP1" class="font-semibold text-green-400">--</div>
                        </div>
                        <div class="p-2 bg-green-900/30 rounded">
                            <span class="text-gray-400">TP2 (1.5:1)</span>
                            <div id="scalpTP2" class="font-semibold text-green-400">--</div>
                        </div>
                    </div>
                    <div class="mt-2 p-2 bg-slate-700/30 rounded text-xs">
                        <div class="flex justify-between">
                            <span class="text-gray-400">Risk:</span>
                            <span id="scalpRisk" class="font-semibold">$--</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">ATR:</span>
                            <span id="scalpATR" class="font-semibold">$--</span>
                        </div>
                    </div>
                </div>

                <!-- Confluence Factors -->
                <div class="mb-3">
                    <h4 class="text-xs font-semibold text-gray-400 mb-2">Confluence Factors</h4>
                    <div id="confluenceFactors" class="space-y-1 max-h-24 overflow-y-auto scroll-thin">
                        <div class="text-xs text-gray-500 p-2 bg-slate-700/20 rounded">Loading...</div>
                    </div>
                </div>

                <!-- Confidence Meter -->
                <div class="mb-3">
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-400">Confidence</span>
                        <span id="scalpConfidence" class="font-semibold">0%</span>
                    </div>
                    <div class="indicator-bar">
                        <div id="scalpConfidenceBar" class="indicator-fill bg-cyan-500" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="grid grid-cols-4 gap-1 text-center text-xs mb-3">
                    <div class="p-1.5 bg-slate-700/30 rounded">
                        <div class="text-gray-400">RSI</div>
                        <div id="scalpRSI" class="font-semibold">--</div>
                    </div>
                    <div class="p-1.5 bg-slate-700/30 rounded">
                        <div class="text-gray-400">EMA9</div>
                        <div id="scalpEMA9" class="font-semibold">--</div>
                    </div>
                    <div class="p-1.5 bg-slate-700/30 rounded">
                        <div class="text-gray-400">EMA21</div>
                        <div id="scalpEMA21" class="font-semibold">--</div>
                    </div>
                    <div class="p-1.5 bg-slate-700/30 rounded">
                        <div class="text-gray-400">VWAP</div>
                        <div id="scalpVWAP" class="font-semibold">--</div>
                    </div>
                </div>

                <!-- Suggestions List -->
                <div>
                    <h4 class="text-xs font-semibold text-gray-400 mb-2">Action Plan</h4>
                    <div id="scalpSuggestions" class="space-y-2">
                        <div class="p-2 bg-slate-700/30 rounded text-sm text-gray-400">Loading suggestions...</div>
                    </div>
                </div>

                <!-- Session Warning -->
                <div id="sessionWarning" class="hidden mt-3 p-2 rounded text-xs">
                    <span id="sessionWarningText"></span>
                </div>
            </div>

            <!-- P&L Tracker -->
            <div class="card p-4">
                <h2 class="text-lg font-semibold mb-3">P&L Tracker</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <div class="p-2 bg-slate-700/50 rounded-lg">
                            <div class="text-xs text-gray-400">Balance</div>
                            <div id="currentBalance" class="text-lg font-bold text-green-400">$5,000</div>
                        </div>
                        <div class="p-2 bg-slate-700/50 rounded-lg">
                            <div class="text-xs text-gray-400">Total P&L</div>
                            <div id="totalPnl" class="text-lg font-bold">$0.00</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div class="p-2 bg-slate-700/30 rounded">
                            <div class="text-gray-400">Today</div>
                            <div id="todayPnl" class="font-semibold">$0</div>
                            <div id="todayTrades" class="text-gray-500">0 trades</div>
                        </div>
                        <div class="p-2 bg-slate-700/30 rounded">
                            <div class="text-gray-400">Week</div>
                            <div id="weekPnl" class="font-semibold">$0</div>
                            <div id="weekTrades" class="text-gray-500">0 trades</div>
                        </div>
                        <div class="p-2 bg-slate-700/30 rounded">
                            <div class="text-gray-400">Month</div>
                            <div id="monthPnl" class="font-semibold">$0</div>
                            <div id="monthTrades" class="text-gray-500">0 trades</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-xs">
                        <div class="flex justify-between p-2 bg-slate-700/20 rounded">
                            <span class="text-gray-400">Win Rate</span>
                            <span id="winRate" class="font-semibold">--%</span>
                        </div>
                        <div class="flex justify-between p-2 bg-slate-700/20 rounded">
                            <span class="text-gray-400">Profit Factor</span>
                            <span id="profitFactor" class="font-semibold">--</span>
                        </div>
                        <div class="flex justify-between p-2 bg-slate-700/20 rounded">
                            <span class="text-gray-400">Max DD</span>
                            <span id="maxDrawdown" class="font-semibold text-red-400">$0</span>
                        </div>
                        <div class="flex justify-between p-2 bg-slate-700/20 rounded">
                            <span class="text-gray-400">Streak</span>
                            <span id="streak" class="font-semibold">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Trades -->
            <div class="card p-4">
                <h2 class="text-sm font-semibold mb-2">Recent Trades</h2>
                <div id="recentTrades" class="space-y-1 max-h-24 overflow-y-auto scroll-thin">
                    <div class="p-2 bg-slate-700/30 rounded text-center text-gray-400 text-xs">
                        No recent trades
                    </div>
                </div>
            </div>

            <!-- Risk Disclaimer -->
            <div class="card p-3 bg-yellow-900/20 border border-yellow-600/30">
                <p class="text-xs text-yellow-200/80">
                    <strong>Risk Warning:</strong> Trading involves significant risk. Past performance does not guarantee future results.
                </p>
            </div>
        </div>
    </div>

    <script>
        // Store manipulation history
        let manipulationHistory = [];

        // Initialize TradingView charts
        function initCharts() {
            new TradingView.widget({
                "autosize": true,
                "symbol": "OANDA:XAUUSD",
                "interval": "5",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#1e293b",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": false,
                "container_id": "xauChart",
                "studies": ["RSI@tv-basicstudies", "MACD@tv-basicstudies"]
            });

            new TradingView.widget({
                "autosize": true,
                "symbol": "OANDA:XAGUSD",
                "interval": "5",
                "timezone": "Etc/UTC",
                "theme": "dark",
                "style": "1",
                "locale": "en",
                "toolbar_bg": "#1e293b",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": false,
                "container_id": "xagChart",
                "studies": ["RSI@tv-basicstudies"]
            });
        }

        // Fetch metal prices
        async function fetchPrices() {
            try {
                const response = await fetch('/api/metals/prices');
                const data = await response.json();

                if (data.xau) {
                    document.getElementById('xauPrice').textContent = `$${data.xau.price.toFixed(2)}`;
                    document.getElementById('xauPrice').className =
                        `text-xl font-bold ${data.xau.change >= 0 ? 'text-green-400' : 'text-red-400'}`;
                }
                if (data.xag) {
                    document.getElementById('xagPrice').textContent = `$${data.xag.price.toFixed(3)}`;
                    document.getElementById('xagPrice').className =
                        `text-xl font-bold ${data.xag.change >= 0 ? 'text-green-400' : 'text-red-400'}`;
                }
                if (data.session) {
                    document.getElementById('currentSession').textContent = data.session.name;
                    const riskEl = document.getElementById('sessionRisk');
                    riskEl.textContent = data.session.manipulation_risk;
                    riskEl.className = `ml-2 px-2 py-0.5 rounded text-xs risk-${data.session.manipulation_risk.toLowerCase()}`;
                }
            } catch (error) {
                console.error('Error fetching prices:', error);
            }
        }

        // Fetch correlations
        async function fetchCorrelations() {
            try {
                const response = await fetch('/api/metals/correlations');
                const data = await response.json();

                if (data.correlations) {
                    data.correlations.forEach(asset => {
                        const priceEl = document.getElementById(`${asset.symbol.toLowerCase().replace('/', '')}Price`);
                        const changeEl = document.getElementById(`${asset.symbol.toLowerCase().replace('/', '')}Change`);

                        if (priceEl) {
                            priceEl.textContent = asset.price.toFixed(asset.price > 100 ? 2 : 4);
                        }
                        if (changeEl) {
                            changeEl.textContent = `${asset.change_percent >= 0 ? '+' : ''}${asset.change_percent.toFixed(2)}%`;
                            changeEl.className = `text-sm ${asset.change_percent >= 0 ? 'text-green-400' : 'text-red-400'}`;
                        }
                    });
                }
            } catch (error) {
                console.error('Error fetching correlations:', error);
            }
        }

        // Render signal card
        function renderSignalCard(signal, symbol) {
            if (!signal) {
                return `<div class="p-3 bg-slate-700/30 rounded-lg text-center text-gray-400 text-sm">No active signal</div>`;
            }

            const isBuy = signal.direction === 'buy';
            return `
                <div class="p-3 rounded-lg ${isBuy ? 'signal-buy bg-green-900/20' : 'signal-sell bg-red-900/20'}">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-bold ${isBuy ? 'text-green-400' : 'text-red-400'}">
                            ${isBuy ? '↑ BUY' : '↓ SELL'}
                        </span>
                        <span class="text-sm">@ ${signal.entry.toFixed(2)}</span>
                    </div>
                    <div class="space-y-1 text-xs">
                        <div class="flex justify-between">
                            <span class="text-gray-400">SL:</span>
                            <span class="text-red-400">${signal.stop_loss.toFixed(2)}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">TP1:</span>
                            <span class="text-green-400">${signal.take_profit_1.toFixed(2)} (${signal.risk_reward_1.toFixed(1)}R)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">TP2:</span>
                            <span class="text-green-400">${signal.take_profit_2.toFixed(2)} (${signal.risk_reward_2.toFixed(1)}R)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Size:</span>
                            <span>${signal.position_size} lots</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-400">Confidence:</span>
                            <span class="font-semibold">${(signal.confidence * 100).toFixed(0)}%</span>
                        </div>
                        <div class="mt-2 pt-2 border-t border-slate-600 text-gray-400">
                            ${signal.reasoning}
                        </div>
                    </div>
                </div>
            `;
        }

        // Update indicators display
        function updateIndicators(prefix, data) {
            if (!data || !data.indicators) return;

            const ind = data.indicators;

            // RSI
            document.getElementById(`${prefix}RsiValue`).textContent = ind.rsi.toFixed(1);
            const rsiBar = document.getElementById(`${prefix}RsiBar`);
            rsiBar.style.width = `${ind.rsi}%`;
            rsiBar.className = `indicator-fill ${ind.rsi > 70 ? 'bg-red-500' : ind.rsi < 30 ? 'bg-green-500' : 'bg-blue-500'}`;

            // MACD
            document.getElementById(`${prefix}Macd`).textContent = ind.macd.toFixed(2);
            document.getElementById(`${prefix}MacdSignal`).textContent = ind.macd_signal.toFixed(2);

            // EMAs
            document.getElementById(`${prefix}Ema9`).textContent = ind.ema_9.toFixed(2);
            document.getElementById(`${prefix}Ema21`).textContent = ind.ema_21.toFixed(2);

            // Bias
            if (data.market_bias) {
                const biasEl = document.getElementById(`${prefix}Bias`);
                biasEl.textContent = data.market_bias;
                biasEl.className = `text-xs font-semibold px-2 py-0.5 rounded ${
                    data.market_bias === 'BULLISH' ? 'bg-green-600' :
                    data.market_bias === 'BEARISH' ? 'bg-red-600' : 'bg-gray-600'
                }`;
            }
        }

        // Fetch manipulation data
        async function fetchManipulation() {
            try {
                const response = await fetch('/api/metals/manipulation');
                const data = await response.json();

                // Update risk score
                const scoreEl = document.getElementById('riskScoreValue');
                scoreEl.textContent = `${(data.manipulation_score * 100).toFixed(0)}%`;
                scoreEl.className = `text-lg font-bold ${
                    data.manipulation_score > 0.6 ? 'text-red-400' :
                    data.manipulation_score > 0.3 ? 'text-yellow-400' : 'text-green-400'
                }`;

                // Update current alerts
                const alertsContainer = document.getElementById('manipulationAlerts');
                if (data.active_alerts && data.active_alerts.length > 0) {
                    alertsContainer.innerHTML = data.active_alerts.map(alert => `
                        <div class="p-2 rounded-lg text-sm ${
                            alert.severity === 'critical' ? 'bg-red-900/30 border-l-4 border-red-500' :
                            alert.severity === 'high' ? 'bg-orange-900/30 border-l-4 border-orange-500' :
                            'bg-yellow-900/30 border-l-4 border-yellow-500'
                        }">
                            <div class="flex items-center justify-between">
                                <span class="font-semibold">${alert.type}</span>
                                <span class="text-xs text-gray-400">${alert.severity.toUpperCase()}</span>
                            </div>
                            <p class="text-xs text-gray-300 mt-1">${alert.description}</p>
                            ${alert.expected_reversal ? `
                                <p class="text-xs mt-1 ${alert.expected_reversal === 'UP' ? 'text-green-400' : 'text-red-400'}">
                                    Expected: ${alert.expected_reversal}
                                </p>
                            ` : ''}
                        </div>
                    `).join('');

                    // Add to history
                    data.active_alerts.forEach(alert => {
                        const historyItem = {
                            ...alert,
                            timestamp: new Date().toISOString()
                        };
                        manipulationHistory.unshift(historyItem);
                    });
                    // Keep only last 10
                    manipulationHistory = manipulationHistory.slice(0, 10);
                    updateManipulationHistory();
                } else {
                    alertsContainer.innerHTML = `
                        <div class="p-2 bg-green-900/20 rounded-lg text-green-400 text-sm">
                            No manipulation alerts - Market appears clean
                        </div>
                    `;
                }

                // Update key levels - structured
                const supportLevels = [];
                const resistanceLevels = [];

                if (data.key_levels) {
                    data.key_levels.forEach(level => {
                        if (level.type === 'SUPPORT') {
                            supportLevels.push(level);
                        } else if (level.type === 'RESISTANCE') {
                            resistanceLevels.push(level);
                        }
                    });
                }

                document.getElementById('supportLevels').innerHTML = supportLevels.length > 0 ?
                    supportLevels.slice(0, 3).map((l, i) => `
                        <div class="flex justify-between p-2 bg-green-900/20 rounded text-sm">
                            <span class="text-green-400">S${i+1}</span>
                            <span class="text-green-300">${l.price.toFixed(2)}</span>
                        </div>
                    `).join('') :
                    '<div class="text-xs text-gray-500 p-2">No support levels</div>';

                document.getElementById('resistanceLevels').innerHTML = resistanceLevels.length > 0 ?
                    resistanceLevels.slice(0, 3).map((l, i) => `
                        <div class="flex justify-between p-2 bg-red-900/20 rounded text-sm">
                            <span class="text-red-400">R${i+1}</span>
                            <span class="text-red-300">${l.price.toFixed(2)}</span>
                        </div>
                    `).join('') :
                    '<div class="text-xs text-gray-500 p-2">No resistance levels</div>';

            } catch (error) {
                console.error('Error fetching manipulation data:', error);
            }
        }

        // Update manipulation history display
        function updateManipulationHistory() {
            const container = document.getElementById('manipulationHistory');
            if (manipulationHistory.length === 0) {
                container.innerHTML = '<div class="text-xs text-gray-500 p-2 bg-slate-700/20 rounded">No recent events</div>';
                return;
            }

            container.innerHTML = manipulationHistory.map(item => {
                const time = new Date(item.timestamp).toLocaleTimeString();
                return `
                    <div class="flex items-center justify-between p-1.5 bg-slate-700/20 rounded text-xs">
                        <div class="flex items-center gap-2">
                            <span class="${
                                item.severity === 'critical' ? 'text-red-400' :
                                item.severity === 'high' ? 'text-orange-400' : 'text-yellow-400'
                            }">●</span>
                            <span class="text-gray-300">${item.type}</span>
                        </div>
                        <span class="text-gray-500">${time}</span>
                    </div>
                `;
            }).join('');
        }

        // Fetch market intelligence
        async function fetchMarketIntelligence() {
            try {
                const response = await fetch('/api/metals/intelligence');
                const data = await response.json();

                if (data.gold) {
                    document.getElementById('goldSummary').innerHTML = `
                        <p><strong>Price Action:</strong> ${data.gold.price_action}</p>
                        <p><strong>Key Drivers:</strong> ${data.gold.drivers}</p>
                        <p><strong>Outlook:</strong> ${data.gold.outlook}</p>
                    `;
                }

                if (data.silver) {
                    document.getElementById('silverSummary').innerHTML = `
                        <p><strong>Price Action:</strong> ${data.silver.price_action}</p>
                        <p><strong>Key Drivers:</strong> ${data.silver.drivers}</p>
                        <p><strong>Outlook:</strong> ${data.silver.outlook}</p>
                    `;
                }

                if (data.central_banks) {
                    document.getElementById('centralBankSummary').innerHTML = `
                        <p><strong>Fed:</strong> ${data.central_banks.fed}</p>
                        <p><strong>ECB:</strong> ${data.central_banks.ecb}</p>
                        <p><strong>Gold Reserves:</strong> ${data.central_banks.gold_reserves}</p>
                    `;
                }

                if (data.contracts) {
                    document.getElementById('contractInfo').innerHTML = `
                        <p><strong>COMEX Gold:</strong> ${data.contracts.gold_expiry}</p>
                        <p><strong>COMEX Silver:</strong> ${data.contracts.silver_expiry}</p>
                        <p><strong>Delivery:</strong> ${data.contracts.delivery_info}</p>
                    `;
                }

            } catch (error) {
                console.error('Error fetching intelligence:', error);
                // Show default data
                document.getElementById('goldSummary').innerHTML = `
                    <p><strong>Price Action:</strong> Gold trading near $2,900 level with mixed signals</p>
                    <p><strong>Key Drivers:</strong> USD strength, Treasury yields, geopolitical tensions</p>
                    <p><strong>Outlook:</strong> Watch for Fed commentary and economic data releases</p>
                `;
                document.getElementById('silverSummary').innerHTML = `
                    <p><strong>Price Action:</strong> Silver following gold with higher volatility</p>
                    <p><strong>Key Drivers:</strong> Industrial demand, solar panel production, gold correlation</p>
                    <p><strong>Outlook:</strong> Industrial demand supporting prices amid green energy transition</p>
                `;
                document.getElementById('centralBankSummary').innerHTML = `
                    <p><strong>Fed:</strong> Monitoring inflation data for rate decision timing</p>
                    <p><strong>ECB:</strong> Cautious stance on rate cuts</p>
                    <p><strong>Gold Reserves:</strong> Central banks continue net buying trend</p>
                `;
                document.getElementById('contractInfo').innerHTML = `
                    <p><strong>COMEX Gold (GC):</strong> Front month active, rollover approaching</p>
                    <p><strong>COMEX Silver (SI):</strong> Tracking gold futures movement</p>
                    <p><strong>Delivery:</strong> Physical delivery typically 1st-3rd business day</p>
                `;
            }
        }

        // Fetch P&L data
        async function fetchPnL() {
            try {
                const response = await fetch('/api/metals/pnl');
                const data = await response.json();

                document.getElementById('currentBalance').textContent = `$${data.balance.current.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                const totalPnl = data.balance.total_pnl;
                const totalPnlEl = document.getElementById('totalPnl');
                totalPnlEl.textContent = `${totalPnl >= 0 ? '+' : ''}$${totalPnl.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
                totalPnlEl.className = `text-lg font-bold ${totalPnl >= 0 ? 'text-green-400' : 'text-red-400'}`;

                updatePeriodStat('today', data.today);
                updatePeriodStat('week', data.weekly);
                updatePeriodStat('month', data.monthly);

                document.getElementById('winRate').textContent = `${data.metrics.win_rate}%`;
                document.getElementById('profitFactor').textContent = data.metrics.profit_factor.toFixed(2);
                document.getElementById('maxDrawdown').textContent = `$${data.metrics.max_drawdown.toFixed(2)}`;

                const streakEl = document.getElementById('streak');
                streakEl.textContent = `${data.metrics.current_streak} ${data.metrics.streak_type}`;
                streakEl.className = `font-semibold ${data.metrics.streak_type === 'WIN' ? 'text-green-400' : 'text-red-400'}`;

                const tradesContainer = document.getElementById('recentTrades');
                if (data.recent_trades && data.recent_trades.length > 0) {
                    tradesContainer.innerHTML = data.recent_trades.map(trade => `
                        <div class="flex items-center justify-between p-1.5 bg-slate-700/30 rounded text-xs">
                            <div class="flex items-center gap-2">
                                <span class="${trade.direction === 'BUY' ? 'text-green-400' : 'text-red-400'}">
                                    ${trade.direction}
                                </span>
                                <span class="text-gray-400">${trade.symbol}</span>
                            </div>
                            <span class="${trade.pnl >= 0 ? 'text-green-400' : 'text-red-400'}">
                                ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}
                            </span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error fetching P&L:', error);
            }
        }

        function updatePeriodStat(period, data) {
            const pnlEl = document.getElementById(`${period}Pnl`);
            const tradesEl = document.getElementById(`${period}Trades`);

            if (pnlEl && data) {
                pnlEl.textContent = `${data.pnl >= 0 ? '+' : ''}$${data.pnl.toFixed(2)}`;
                pnlEl.className = `font-semibold ${data.pnl >= 0 ? 'text-green-400' : 'text-red-400'}`;
            }
            if (tradesEl && data) {
                tradesEl.textContent = `${data.trades} trades`;
            }
        }

        function updateTimestamp() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        async function handleRefresh() {
            const btn = document.getElementById('refreshBtn');
            const icon = document.getElementById('refreshIcon');
            const text = document.getElementById('refreshText');

            btn.disabled = true;
            btn.classList.add('opacity-75');
            icon.style.animation = 'spin 1s linear infinite';
            text.textContent = 'Refreshing...';

            if (!document.getElementById('spinStyle')) {
                const style = document.createElement('style');
                style.id = 'spinStyle';
                style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
                document.head.appendChild(style);
            }

            try {
                await refreshAll();
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-75');
                icon.style.animation = '';
                text.textContent = 'Refresh';
            }
        }

        async function forceRefresh() {
            try {
                const response = await fetch('/api/metals/refresh', { method: 'POST' });
                const data = await response.json();

                if (data.xau) {
                    document.getElementById('xauPrice').textContent = `$${data.xau.price.toFixed(2)}`;
                    document.getElementById('xauPrice').className =
                        `text-xl font-bold ${data.xau.change >= 0 ? 'text-green-400' : 'text-red-400'}`;
                }
                if (data.xag) {
                    document.getElementById('xagPrice').textContent = `$${data.xag.price.toFixed(3)}`;
                    document.getElementById('xagPrice').className =
                        `text-xl font-bold ${data.xag.change >= 0 ? 'text-green-400' : 'text-red-400'}`;
                }
                if (data.session) {
                    document.getElementById('currentSession').textContent = data.session.name;
                    const riskEl = document.getElementById('sessionRisk');
                    riskEl.textContent = data.session.manipulation_risk;
                    riskEl.className = `ml-2 px-2 py-0.5 rounded text-xs risk-${data.session.manipulation_risk.toLowerCase()}`;
                }
                return true;
            } catch (error) {
                console.error('Error forcing refresh:', error);
                return false;
            }
        }

        // Fetch scalp trading suggestions
        async function fetchScalpSuggestions() {
            try {
                const symbol = document.getElementById('scalpSymbol').value;
                const response = await fetch(`/api/metals/scalp?symbol=${encodeURIComponent(symbol)}`);
                const data = await response.json();

                // Update action banner
                const actionEl = document.getElementById('scalpAction');
                const entryEl = document.getElementById('scalpEntry');

                let actionClass = 'bg-slate-700/50';
                let actionText = data.action;
                let actionDetail = '';

                if (data.action === 'BUY_NOW') {
                    actionClass = 'bg-green-900/50 border-2 border-green-500';
                    actionText = '🟢 BUY NOW';
                    actionDetail = `Entry @ $${data.entry.toFixed(2)}`;
                    entryEl.classList.remove('hidden');
                } else if (data.action === 'SELL_NOW') {
                    actionClass = 'bg-red-900/50 border-2 border-red-500';
                    actionText = '🔴 SELL NOW';
                    actionDetail = `Entry @ $${data.entry.toFixed(2)}`;
                    entryEl.classList.remove('hidden');
                } else if (data.action === 'PREPARE_BUY') {
                    actionClass = 'bg-green-900/30 border border-green-600';
                    actionText = '🟡 PREPARE BUY';
                    actionDetail = 'Wait for better entry';
                    entryEl.classList.remove('hidden');
                } else if (data.action === 'PREPARE_SELL') {
                    actionClass = 'bg-red-900/30 border border-red-600';
                    actionText = '🟡 PREPARE SELL';
                    actionDetail = 'Wait for better entry';
                    entryEl.classList.remove('hidden');
                } else {
                    actionClass = 'bg-slate-700/50 border border-slate-600';
                    actionText = '⏸️ WAIT';
                    actionDetail = 'No clear setup - stay flat';
                    entryEl.classList.add('hidden');
                }

                actionEl.className = `p-3 rounded-lg mb-3 text-center ${actionClass}`;
                actionEl.innerHTML = `
                    <div class="text-2xl font-bold mb-1">${actionText}</div>
                    <div class="text-sm ${data.action.includes('BUY') ? 'text-green-400' : data.action.includes('SELL') ? 'text-red-400' : 'text-gray-400'}">${actionDetail}</div>
                    <div class="text-xs text-gray-500 mt-1">@ $${data.current_price.toFixed(2)}</div>
                `;

                // Update entry details
                if (data.entry) {
                    document.getElementById('scalpEntryPrice').textContent = `$${data.entry.toFixed(2)}`;
                    document.getElementById('scalpSL').textContent = `$${data.stop_loss.toFixed(2)}`;
                    document.getElementById('scalpTP1').textContent = `$${data.take_profit_1.toFixed(2)}`;
                    document.getElementById('scalpTP2').textContent = `$${data.take_profit_2.toFixed(2)}`;
                    document.getElementById('scalpRisk').textContent = `$${data.risk_amount.toFixed(2)}`;
                    document.getElementById('scalpATR').textContent = `$${data.atr.toFixed(2)}`;
                }

                // Update quick stats
                document.getElementById('scalpRSI').textContent = data.rsi.toFixed(1);
                document.getElementById('scalpRSI').className = `font-semibold ${data.rsi > 70 ? 'text-red-400' : data.rsi < 30 ? 'text-green-400' : 'text-white'}`;
                document.getElementById('scalpEMA9').textContent = data.ema_9.toFixed(0);
                document.getElementById('scalpEMA21').textContent = data.ema_21.toFixed(0);
                document.getElementById('scalpVWAP').textContent = data.vwap.toFixed(0);

                // Update confidence
                document.getElementById('scalpConfidence').textContent = `${data.confidence.toFixed(0)}%`;
                const confBar = document.getElementById('scalpConfidenceBar');
                confBar.style.width = `${data.confidence}%`;
                confBar.className = `indicator-fill ${data.confidence >= 60 ? 'bg-green-500' : data.confidence >= 40 ? 'bg-yellow-500' : 'bg-red-500'}`;

                // Update confluence factors
                const factorsEl = document.getElementById('confluenceFactors');
                if (data.confluence_factors && data.confluence_factors.length > 0) {
                    factorsEl.innerHTML = data.confluence_factors.map(f => `
                        <div class="flex items-center justify-between p-1.5 bg-slate-700/30 rounded text-xs">
                            <span class="text-gray-300">${f.factor}</span>
                            <span class="${
                                f.direction === 'BUY' ? 'text-green-400' :
                                f.direction === 'SELL' ? 'text-red-400' :
                                f.direction === 'FAVORABLE' ? 'text-cyan-400' :
                                f.direction === 'CAUTION' ? 'text-orange-400' : 'text-gray-400'
                            }">${f.direction}</span>
                        </div>
                    `).join('');
                } else {
                    factorsEl.innerHTML = '<div class="text-xs text-gray-500 p-2 bg-slate-700/20 rounded">No confluence factors</div>';
                }

                // Update suggestions
                const suggestionsEl = document.getElementById('scalpSuggestions');
                if (data.suggestions && data.suggestions.length > 0) {
                    suggestionsEl.innerHTML = data.suggestions.map(s => {
                        let bgClass = 'bg-slate-700/30';
                        let borderClass = '';
                        let icon = '';

                        if (s.type === 'ENTRY') {
                            bgClass = data.action.includes('BUY') ? 'bg-green-900/40' : 'bg-red-900/40';
                            borderClass = data.action.includes('BUY') ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500';
                            icon = data.action.includes('BUY') ? '🎯' : '🎯';
                        } else if (s.type === 'TARGET') {
                            bgClass = 'bg-blue-900/30';
                            borderClass = 'border-l-4 border-blue-500';
                            icon = '💰';
                        } else if (s.type === 'WARNING') {
                            bgClass = 'bg-orange-900/30';
                            borderClass = 'border-l-4 border-orange-500';
                            icon = '⚠️';
                        } else if (s.type === 'INFO') {
                            bgClass = 'bg-cyan-900/30';
                            borderClass = 'border-l-4 border-cyan-500';
                            icon = 'ℹ️';
                        } else if (s.type === 'LEVELS') {
                            bgClass = 'bg-purple-900/30';
                            borderClass = 'border-l-4 border-purple-500';
                            icon = '📊';
                        } else if (s.type === 'RULES') {
                            bgClass = 'bg-slate-700/30';
                            borderClass = 'border-l-4 border-slate-500';
                            icon = '📋';
                        } else if (s.type === 'WAIT') {
                            bgClass = 'bg-slate-700/40';
                            borderClass = 'border-l-4 border-slate-400';
                            icon = '⏸️';
                        } else if (s.type === 'ALERT') {
                            bgClass = 'bg-yellow-900/30';
                            borderClass = 'border-l-4 border-yellow-500';
                            icon = '🔔';
                        }

                        return `
                            <div class="p-2 rounded ${bgClass} ${borderClass}">
                                <div class="font-semibold text-sm flex items-center gap-2">
                                    <span>${icon}</span>
                                    <span>${s.text}</span>
                                </div>
                                <div class="text-xs text-gray-400 mt-1 ml-6">${s.detail}</div>
                            </div>
                        `;
                    }).join('');
                }

                // Update session warning
                const warningEl = document.getElementById('sessionWarning');
                const warningTextEl = document.getElementById('sessionWarningText');
                if (data.session_risk === 'high' || data.session_risk === 'highest') {
                    warningEl.classList.remove('hidden');
                    warningEl.className = 'mt-3 p-2 rounded text-xs bg-orange-900/30 border border-orange-500';
                    warningTextEl.textContent = `⚠️ ${data.session} - ${data.session_risk.toUpperCase()} manipulation risk. Reduce size or wait.`;
                } else if (data.session_risk === 'low') {
                    warningEl.classList.remove('hidden');
                    warningEl.className = 'mt-3 p-2 rounded text-xs bg-green-900/30 border border-green-600';
                    warningTextEl.textContent = `✅ ${data.session} - Low manipulation risk. Good for scalping.`;
                } else {
                    warningEl.classList.add('hidden');
                }

            } catch (error) {
                console.error('Error fetching scalp suggestions:', error);
                document.getElementById('scalpAction').innerHTML = `
                    <div class="text-lg font-bold text-red-400">Error</div>
                    <div class="text-sm text-gray-400">Failed to load scalp data</div>
                `;
            }
        }

        // ===== POLYMARKET FUNCTIONS =====

        let allPolyEvents = [];
        let currentFeedFilter = 'all';

        function fmtVolume(v) {
            if (v >= 1_000_000) return `$${(v/1_000_000).toFixed(1)}M`;
            if (v >= 1_000) return `$${(v/1_000).toFixed(0)}K`;
            return `$${v.toFixed(0)}`;
        }

        function renderPolyCard(event) {
            const yesW = event.yes_price;
            const noW = 100 - yesW;
            const bias = event.metals_bias || 'neutral';
            const cardClass = bias === 'bullish' ? 'pm-bullish' : bias === 'bearish' ? 'pm-bearish' : 'pm-neutral';
            const relevance = event.metals_relevance || 0;
            return `
                <div class="pm-card ${cardClass}">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex-1 min-w-0">
                            <div class="text-xs font-medium text-gray-200 leading-tight truncate" title="${event.title}">${event.title}</div>
                            ${event.relevance_reason ? `<div class="text-xs text-gray-500 mt-0.5 truncate">${event.relevance_reason}</div>` : ''}
                        </div>
                        <div class="flex-shrink-0 flex flex-col items-end gap-1">
                            <span class="volume-chip">${fmtVolume(event.volume)}</span>
                            ${bias !== 'neutral' ? `<span class="bias-pill bias-${bias}" style="font-size:9px">${bias.toUpperCase()}</span>` : ''}
                        </div>
                    </div>
                    <div class="pm-bar mt-2">
                        <div class="pm-bar-yes" style="width:${yesW}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span class="text-green-400">Yes ${yesW}%</span>
                        <span class="text-red-400">No ${noW.toFixed(1)}%</span>
                    </div>
                </div>
            `;
        }

        function renderGeoCard(event) {
            const yesW = event.yes_price;
            return `
                <div class="event-feed-item">
                    <div class="flex items-start justify-between gap-2">
                        <span class="text-xs text-gray-200 leading-tight flex-1">${event.title}</span>
                        <span class="volume-chip flex-shrink-0">${fmtVolume(event.volume)}</span>
                    </div>
                    <div class="pm-bar mt-2">
                        <div class="pm-bar-yes" style="width:${yesW}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>Yes <strong class="text-orange-300">${yesW}%</strong></span>
                        <span class="text-gray-600">${event.category || ''}</span>
                    </div>
                </div>
            `;
        }

        function renderFeedItem(event) {
            // Determine severity badge based on volume & relevance
            const vol = event.volume || 0;
            let severity = 'low';
            let severityLabel = 'LOW';
            if (vol > 500_000 || (event.metals_relevance > 70)) { severity = 'critical'; severityLabel = 'CRITICAL'; }
            else if (vol > 100_000 || (event.metals_relevance > 45)) { severity = 'high'; severityLabel = 'HIGH'; }

            const bias = event.metals_bias || 'neutral';
            return `
                <div class="event-feed-item" data-bias="${bias}">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex items-center gap-2 flex-shrink-0">
                            <span class="badge-${severity} px-1.5 py-0.5 rounded text-xs font-bold">${severityLabel}</span>
                        </div>
                        <span class="text-xs text-gray-200 flex-1 leading-tight">${event.title}</span>
                        <span class="volume-chip flex-shrink-0">${fmtVolume(event.volume)}</span>
                    </div>
                    <div class="flex items-center justify-between mt-2">
                        <div class="pm-bar flex-1 mr-3">
                            <div class="pm-bar-yes" style="width:${event.yes_price}%"></div>
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                            <span class="text-green-400">✓ ${event.yes_price}%</span>
                            ${bias !== 'neutral' ? `<span class="bias-pill bias-${bias}">${bias.toUpperCase()}</span>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function filterFeed(filter) {
            currentFeedFilter = filter;
            // Update button styles
            ['all','bull','bear'].forEach(k => {
                const btn = document.getElementById(`feed${k.charAt(0).toUpperCase()+k.slice(1)}`);
                if (btn) btn.className = `px-2 py-0.5 text-xs rounded ${filter === k || (filter==='bullish'&&k==='bull') || (filter==='bearish'&&k==='bear') || (filter==='all'&&k==='all') ? 'bg-slate-600 text-white' : 'bg-slate-700 text-gray-400'}`;
            });
            renderEventsFeed(allPolyEvents);
        }

        function renderEventsFeed(events) {
            const container = document.getElementById('globalEventsFeed');
            let filtered = events;
            if (currentFeedFilter === 'bullish') filtered = events.filter(e => e.metals_bias === 'bullish');
            else if (currentFeedFilter === 'bearish') filtered = events.filter(e => e.metals_bias === 'bearish');

            if (!filtered.length) {
                container.innerHTML = '<div class="text-xs text-gray-500 p-3 text-center">No events matching filter</div>';
                return;
            }
            container.innerHTML = filtered.map(renderFeedItem).join('');
        }

        async function fetchPolymarketIntel() {
            try {
                const resp = await fetch('/api/polymarket/metals-intel');
                const data = await resp.json();

                // Update metals-relevant markets
                const metalsEl = document.getElementById('polymarketsMetals');
                if (data.metals_signals && data.metals_signals.length > 0) {
                    metalsEl.innerHTML = data.metals_signals.slice(0, 5).map(renderPolyCard).join('');
                } else {
                    metalsEl.innerHTML = '<div class="text-xs text-gray-500 p-3 text-center">No metals-relevant markets found</div>';
                }

                // Update geopolitical
                const geoEl = document.getElementById('polymarketsGeo');
                if (data.geopolitical && data.geopolitical.length > 0) {
                    geoEl.innerHTML = data.geopolitical.slice(0, 4).map(renderGeoCard).join('');
                } else {
                    geoEl.innerHTML = '<div class="text-xs text-gray-500 p-2 text-center">No geopolitical markets</div>';
                }

                // Update summary stats
                document.getElementById('polyMarketCount').textContent = data.signal_count || 0;

                const bias = data.overall_bias || 'neutral';
                const biasEl = document.getElementById('polyOverallBias');
                biasEl.textContent = bias.toUpperCase();
                biasEl.className = `font-bold ${bias === 'bullish' ? 'text-green-400' : bias === 'bearish' ? 'text-red-400' : 'text-gray-400'}`;

                // Bias chip in header
                const biasChip = document.getElementById('polyBiasChip');
                biasChip.textContent = bias.toUpperCase();
                biasChip.className = `bias-pill bias-${bias}`;

                // Volume from metals_signals
                const totalVol = (data.metals_signals || []).reduce((s, e) => s + (e.volume || 0), 0);
                document.getElementById('polyTotalVol').textContent = fmtVolume(totalVol);

                // Feed data: combine metals + geo for the global feed
                allPolyEvents = [...(data.metals_signals || []), ...(data.geopolitical || [])];
                allPolyEvents.sort((a,b) => (b.volume||0) - (a.volume||0));
                renderEventsFeed(allPolyEvents);

                // Update news ticker with these events
                updateNewsTicker(allPolyEvents);

            } catch (err) {
                console.error('[Polymarket] Error:', err);
                document.getElementById('polymarketsMetals').innerHTML = '<div class="text-xs text-red-400 p-3 text-center">Failed to load Polymarket data</div>';
            }
        }

        function updateNewsTicker(events) {
            if (!events || events.length === 0) return;
            const ticker = document.getElementById('newsTicker');

            const items = events.slice(0, 12).map(e => {
                const vol = e.volume || 0;
                let severity = 'low';
                if (vol > 500_000 || (e.metals_relevance > 70)) severity = 'critical';
                else if (vol > 100_000 || (e.metals_relevance > 45)) severity = 'high';

                const yesPrice = e.yes_price || 50;
                return `<span class="ticker-item">
                    <span class="badge-${severity} px-1.5 py-0.5 rounded text-xs font-bold">${severity.toUpperCase()}</span>
                    <span class="text-gray-200">${e.title}</span>
                    <span class="text-blue-400 font-semibold">Yes: ${yesPrice}%</span>
                    <span class="text-gray-600">|</span>
                </span>`;
            });

            // Duplicate for seamless loop
            const content = items.join('');
            ticker.innerHTML = content + content;
        }

        function updateActiveSignalCount(goldData, silverData) {
            let count = 0;
            if (goldData && goldData.has_signal) count++;
            if (silverData && silverData.has_signal) count++;
            document.getElementById('activeSignalCount').textContent = count;
        }

        async function refreshAll() {
            await forceRefresh();
            const [goldData, silverData] = await Promise.all([
                fetch('/api/metals/signals?symbol=XAU/USD').then(r => r.json()).catch(() => null),
                fetch('/api/metals/signals?symbol=XAG/USD').then(r => r.json()).catch(() => null),
            ]);

            if (goldData) {
                document.getElementById('goldSignal').innerHTML =
                    renderSignalCard(goldData.has_signal ? goldData.top_signal : null, 'XAU/USD');
                updateIndicators('gold', goldData);
            }
            if (silverData) {
                document.getElementById('silverSignal').innerHTML =
                    renderSignalCard(silverData.has_signal ? silverData.top_signal : null, 'XAG/USD');
                updateIndicators('silver', silverData);
            }
            updateActiveSignalCount(goldData, silverData);

            await Promise.all([
                fetchCorrelations(),
                fetchManipulation(),
                fetchPnL(),
                fetchMarketIntelligence(),
                fetchScalpSuggestions(),
                fetchPolymarketIntel()
            ]);
            updateTimestamp();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
            refreshAll();
            setInterval(refreshAll, 60000);
            // Polymarket refreshes every 2 minutes independently
            setInterval(fetchPolymarketIntel, 120000);
        });
    </script>
</body>
</html>
